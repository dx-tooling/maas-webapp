{% extends '@Webui/base_appshell.html.twig' %}

{% block body %}
    <div class="max-w-4xl mx-auto px-4">
        <h1 class="etfswui-pagetitle mb-10 text-left" data-test-id="page-title">
            MCP Instance Details
            <span class="etfswui-card-subtitle" data-test-id="page-title">{{ instance.instanceType }}</span>
        </h1>

        {{ component('mcp_instances|presentation|health_overview', { instanceId: instance.id }) }}

        <div class="etfswui-card mb-8 text-left" data-test-id="card-general">
            <div class="etfswui-card-title">
                <span class="etfswui-card-title-text">General Instance Data</span>
            </div>
            <div class="etfswui-card-content bg-neutral-50 dark:bg-neutral-900">
                <div class="flex flex-col md:flex-row md:gap-8 gap-4">
                    <div class="flex-1 space-y-4">
                        <div>
                            <div class="etfswui-text font-semibold mb-1">Instance</div>
                            <div class="etfswui-text-small text-dark-600 dark:text-dark-300">ID: {{ instance.id }}</div>
                            <div class="etfswui-text-small text-dark-600 dark:text-dark-300">Container: {{ instance.containerName }}</div>
                            <div class="etfswui-text-small text-dark-600 dark:text-dark-300">Type: {{ instance.instanceType }}</div>
                        </div>
                        <div>
                            <div class="etfswui-text font-semibold mb-1">MCP Bearer Token</div>
                            <input type="text" class="etfswui-form-input w-full max-w-xl" value="{{ instance.mcpBearer }}" readonly onclick="this.select()" aria-label="MCP Bearer Token" data-test-id="mcp-bearer" />
                        </div>
                        <div>
                            <div class="etfswui-text font-semibold mb-1">MCP URLs</div>
                            {% for path in instance.mcpExternalPaths %}
                                <input type="text" class="etfswui-form-input w-full max-w-xl {% if not loop.last %}mb-2{% endif %}" value="https://{{ instance.mcpSubdomain }}{{ path }}" readonly onclick="this.select()" aria-label="MCP URL" data-test-id="mcp-url-{{ loop.index }}" />
                            {% endfor %}
                        </div>
                        {% if instance.vncSubdomain and instance.vncExternalPaths|length > 0 %}
                            <div>
                                <div class="etfswui-text font-semibold mb-1">VNC Web Client</div>
                                <input type="text" class="etfswui-form-input w-full max-w-xl" value="https://{{ instance.vncSubdomain }}{{ instance.vncExternalPaths[0] }}" readonly onclick="this.select()" aria-label="VNC Web Client URL" data-test-id="vnc-url" />
                            </div>
                            <div>
                                <div class="etfswui-text font-semibold mb-1">VNC Password</div>
                                <input type="text" class="etfswui-form-input w-full max-w-xs" value="{{ instance.vncPassword }}" readonly onclick="this.select()" aria-label="VNC Password" data-test-id="vnc-password" />
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-4 text-right">
                    <span class="etfswui-text-small text-dark-400">Created: {{ instance.createdAt|date('M j, Y g:i A') }}</span>
                </div>
            </div>
        </div>

        <div class="etfswui-card mb-8 text-left" data-test-id="card-environment-variables" {{ stimulus_controller('mcp-instances-environment-variables') }}>
            <div class="etfswui-card-title">
                <span class="etfswui-card-title-text">Environment Variables</span>
            </div>
            <div class="etfswui-card-content bg-neutral-50 dark:bg-neutral-900">
                {% if instance.requiredUserEnvVars|length > 0 %}
                    <div class="mb-6">
                        <h4 class="etfswui-text font-semibold mb-3 text-primary-600 dark:text-primary-400">Required Environment Variables</h4>
                        <div class="space-y-3">
                            {% for key, description in instance.requiredUserEnvVars %}
                                <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="etfswui-text font-medium text-yellow-800 dark:text-yellow-200">{{ key }}</span>
                                        <span class="etfswui-text-small text-yellow-600 dark:text-yellow-400">(Required)</span>
                                    </div>
                                    <p class="etfswui-text-small text-yellow-700 dark:text-yellow-300">{{ description }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <form method="post" action="{{ path('mcp_instances_management.presentation.update_env_vars') }}">
                    <input type="hidden" name="instanceId" value="{{ instance.id }}" />
                    <h4 class="etfswui-text font-semibold mb-3">User Environment Variables</h4>
                    <div {{ stimulus_target('mcp-instances-environment-variables', 'container') }}>
                        {% for key, value in instance.userEnvironmentVariables %}
                            <div class="flex gap-2 mb-2 env-var-row" data-test-class="env-var-row">
                                <input type="text" name="env_keys[]" value="{{ key }}" placeholder="KEY" class="etfswui-form-input flex-1" pattern="^[A-Z_][A-Z0-9_]*$" title="Only uppercase letters, numbers, and underscores; must start with a letter or underscore" autocomplete="off" autocapitalize="characters" spellcheck="false" {{ stimulus_action('mcp-instances-environment-variables', 'inputChanged', 'input') }} />
                                <input type="text" name="env_values[]" value="{{ value }}" placeholder="value" class="etfswui-form-input flex-1" {{ stimulus_action('mcp-instances-environment-variables', 'inputChanged', 'input') }} />
                                <button type="button" {{ stimulus_action('mcp-instances-environment-variables', 'remove') }} class="etfswui-button-danger">Remove</button>
                            </div>
                        {% endfor %}
                        {% if instance.userEnvironmentVariables|length == 0 %}
                            <div class="flex gap-2 mb-2 env-var-row" data-test-class="env-var-row">
                                <input type="text" name="env_keys[]" placeholder="KEY" class="etfswui-form-input flex-1" pattern="^[A-Z_][A-Z0-9_]*$" title="Only uppercase letters, numbers, and underscores; must start with a letter or underscore" autocomplete="off" autocapitalize="characters" spellcheck="false" {{ stimulus_action('mcp-instances-environment-variables', 'inputChanged', 'input') }} />
                                <input type="text" name="env_values[]" placeholder="value" class="etfswui-form-input flex-1" {{ stimulus_action('mcp-instances-environment-variables', 'inputChanged', 'input') }} />
                                <button type="button" {{ stimulus_action('mcp-instances-environment-variables', 'remove') }} class="etfswui-button-danger">Remove</button>
                            </div>
                        {% endif %}
                    </div>
                    
                    <template {{ stimulus_target('mcp-instances-environment-variables', 'template') }}>
                        <div class="flex gap-2 mb-2 env-var-row" data-test-class="env-var-row">
                            <input type="text" name="env_keys[]" placeholder="KEY" class="etfswui-form-input flex-1" pattern="^[A-Z_][A-Z0-9_]*$" title="Only uppercase letters, numbers, and underscores; must start with a letter or underscore" autocomplete="off" autocapitalize="characters" spellcheck="false" {{ stimulus_action('mcp-instances-environment-variables', 'inputChanged', 'input') }} />
                            <input type="text" name="env_values[]" placeholder="value" class="etfswui-form-input flex-1" {{ stimulus_action('mcp-instances-environment-variables', 'inputChanged', 'input') }} />
                            <button type="button" {{ stimulus_action('mcp-instances-environment-variables', 'remove') }} class="etfswui-button-danger">Remove</button>
                        </div>
                    </template>
                    
                    <button type="button" {{ stimulus_action('mcp-instances-environment-variables', 'add') }} class="etfswui-button-secondary mb-4" data-test-id="add-env-var-button">Add Variable</button>
                    
                    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md">
                        <div class="flex items-start gap-2">
                            <svg class="h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                            <div>
                                <p class="etfswui-text-small text-blue-800 dark:text-blue-200 font-medium">Container Recreation Required</p>
                                <p class="etfswui-text-small text-blue-700 dark:text-blue-300">Saving environment variables will recreate the Docker container to apply the new variables. This may cause a brief service interruption.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="etfswui-button-default-disabled" {{ stimulus_target('mcp-instances-environment-variables', 'saveButton') }} data-test-id="save-env-vars-button" disabled>Save Environment Variables</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="etfswui-card mb-8 text-left" data-test-id="card-mcp-endpoints">
            <div class="etfswui-card-title">
                <span class="etfswui-card-title-text">MCP Endpoint(s)</span>
            </div>
            <div class="etfswui-card-content bg-green-50 dark:bg-green-900/10 space-y-4">
                {% set mcp_base = 'https://' ~ instance.mcpSubdomain %}
                {% if instance.mcpExternalPaths|length > 0 %}
                    <div class="etfswui-text-small text-dark-600 dark:text-dark-300">Paths: {{ instance.mcpExternalPaths|join(', ') }}</div>
                    {% for p in instance.mcpExternalPaths %}
                        <div class="etfswui-text font-semibold">{{ p }}</div>
                        <div>
                            <div class="etfswui-text-small mb-1">Endpoint URL:</div>
                            <input type="text" class="etfswui-form-input w-full max-w-xl" value="{{ mcp_base ~ p }}" readonly onclick="this.select()" aria-label="MCP Endpoint" />
                        </div>
                        <div>
                            <div class="etfswui-text-small mb-1">cURL Example:</div>
                            <pre class="etfswui-form-input bg-dark-100 dark:bg-dark-900 text-sm p-3 overflow-x-auto select-all"><code>curl \
  -H "Authorization: Bearer {{ instance.mcpBearer }}" \
  {{ mcp_base ~ p }}</code></pre>
                        </div>


                        <div class="etfswui-text-small mb-1">Cursor IDE <em>.cursor/mcp.json</em> Example:</div>
                        <pre class="etfswui-form-input bg-dark-100 dark:bg-dark-900 text-sm p-3 overflow-x-auto select-all">
<code id="cursor-example">{
  "mcpServers": {
    "{{ instance.instanceType }}-remote": {
        "url": "{{ mcp_base ~ p }}",
        "headers": {
            "Authorization": "Bearer {{ instance.mcpBearer }}"
        }
    }
  }
}</code></pre>

                    {% endfor %}
                {% else %}
                    <div class="etfswui-text-small text-dark-500 dark:text-dark-400">No MCP endpoints configured for this instance type.</div>
                {% endif %}
            </div>
        </div>

        {% if instance.vncSubdomain and instance.vncExternalPaths|length > 0 %}
            <div class="etfswui-card mb-8 text-left">
                <div class="etfswui-card-title">
                    <span class="etfswui-card-title-text">VNC Web Client</span>
                </div>
                <div class="etfswui-card-content bg-neutral-50 dark:bg-neutral-900 space-y-4">
                    <div class="etfswui-text mb-2">
                        This allows you to access the MCP session via VNC and watch your AI Agent at work.
                    </div>
                    <div class="flex gap-2 items-center">
                        <a href="https://{{ instance.vncSubdomain }}{{ instance.vncExternalPaths.0 }}?password={{ instance.vncPassword|url_encode }}&resize=scale&autoconnect=true"
                           class="etfswui-link-as-button-secondary"
                           target="_blank" rel="noopener noreferrer">
                            Open VNC Web Client
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="etfswui-card mb-12 text-left">
            <div class="etfswui-card-title">
                <span class="etfswui-card-title-text">Actions</span>
            </div>
            <div class="etfswui-card-content bg-neutral-50 dark:bg-neutral-900">
                <div class="etfswui-card-actions">
                    <form method="post" action="{{ path('mcp_instances_management.presentation.recreate_container') }}" onsubmit="return confirm('Recreate this instance?');">
                        <input type="hidden" name="instanceId" value="{{ instance.id }}" />
                        <button type="submit" class="etfswui-button-secondary">Recreate Instance</button>
                    </form>
                    <form method="post" action="{{ path('mcp_instances_management.presentation.stop_single', {id: instance.id}) }}" onsubmit="return confirm('Stop and remove this instance?');">
                        <button type="submit" class="etfswui-button-danger">Stop & Remove Instance</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <a href="{{ path('mcp_instances_management.presentation.dashboard') }}" class="etfswui-link-as-button-secondary">Back to Overview</a>
        </div>
    </div>
{% endblock %}


