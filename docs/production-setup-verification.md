# Production Setup Verification Guide

This document outlines how to verify that the Docker management works correctly in the production environment where Symfony runs natively.

## Prerequisites Verification

### 1. Docker Daemon Access
Verify the webapp user can access Docker:
```bash
# Test Docker access as www-data user
sudo -u www-data docker ps
sudo -u www-data docker network ls
```

### 2. Docker Network Setup
Ensure the shared network exists:
```bash
# Create network if it doesn't exist
docker network create mcp_instances

# Verify network exists
docker network ls | grep mcp_instances
```

### 3. Native Nginx Configuration
Verify nginx is configured for internal access:
```bash
# Test nginx is listening on port 8080
curl -I http://localhost:8080

# Verify nginx is NOT listening on 80/443
netstat -tlnp | grep :80
netstat -tlnp | grep :443
```

## Docker Management Verification

### 1. Container Creation Test
From the native Symfony application, test container creation:
```php
// Via Symfony console or test script
$dockerService = $container->get(DockerDomainService::class);
$instance = // ... create test McpInstance
$success = $dockerService->createContainer($instance);
```

### 2. Manual Docker Command Test
Test the exact commands generated by DockerDomainService:
```bash
# Example container creation (replace with actual values)
docker run -d \
  --name mcp-test123 \
  --memory=1g \
  --restart=always \
  --network=mcp_instances \
  -e "INSTANCE_ID=test123" \
  -e "SCREEN_WIDTH=1280" \
  -e "SCREEN_HEIGHT=720" \
  -e "COLOR_DEPTH=24" \
  -e "VNC_PASSWORD=testpass" \
  --label "traefik.enable=true" \
  --label "traefik.http.routers.mcp-test123.rule=Host(\`mcp-test123.mcp-as-a-service.com\`)" \
  --label "traefik.http.services.mcp-test123.loadbalancer.server.port=8080" \
  maas-mcp-instance:latest

# Verify container is running
docker ps | grep mcp-test123

# Test container connectivity
docker exec mcp-test123 curl -f http://localhost:8080/mcp
docker exec mcp-test123 curl -f http://localhost:6080
```

### 3. Traefik Integration Test
Verify Traefik can discover and route to containers:
```bash
# Check Traefik discovers the container
curl http://localhost:8080/api/http/routers | jq '.[] | select(.rule | contains("mcp-test123"))'

# Test actual routing (requires DNS or hosts file)
curl -H "Host: mcp-test123.mcp-as-a-service.com" http://localhost/mcp
```

## Common Issues and Solutions

### 1. Permission Denied on Docker Socket
```bash
# Add www-data to docker group
sudo usermod -aG docker www-data

# Restart PHP-FPM to pick up new group membership
sudo systemctl restart php8.2-fpm
```

### 2. Network Communication Issues
```bash
# Verify Traefik can reach host nginx
docker exec traefik-container curl http://host.docker.internal:8080

# Alternative: Use host networking for Traefik
docker run --network host traefik:v2.10 ...
```

### 3. Container Network Isolation
```bash
# Ensure both Traefik and MCP containers are on same network
docker network inspect mcp_instances
```

## Production Deployment Checklist

- [ ] Docker daemon installed and running
- [ ] www-data user added to docker group
- [ ] Docker network `mcp_instances` created
- [ ] Native nginx configured on port 8080
- [ ] Traefik container deployed with host access
- [ ] DNS wildcard record configured
- [ ] Test MCP instance creation via Symfony
- [ ] Verify end-to-end HTTP routing
- [ ] Test ForwardAuth endpoint functionality
